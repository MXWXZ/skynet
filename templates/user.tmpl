{{define "content"}}
<div class="container-fluid">
  <div class="card card-primary">
    <div class="card-header">
      <h3 class="card-title">User List</h3>
    </div>
    <div class="card-body">
      <button class="btn btn-primary cardbtn" data-toggle="modal" data-target="#modal-add">Add
        User</button>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th class="th-70">Status</th>
            <th class="th-70">Role</th>
            <th class="th-170">Created Time</th>
            <th class="th-170">Last Login</th>
            <th>Last IP</th>
            <th class="th-op3">Operation</th>
          </tr>
        </thead>
        <tbody>
          {{range .users}}
          <tr>
            <td>{{ .ID }}</td>
            <td>{{ .Username }}</td>
            {{ if .Online }}
            <td><span class="badge bg-success">ONLINE</span></td>
            {{ else }}
            <td><span class="badge bg-secondary">OFFLINE</span></td>
            {{ end }}
            {{ if eq .Role 2 }}
            <td><span class="badge bg-orange">Admin</span></td>
            {{ else }}
            <td><span class="badge bg-secondary">User</span></td>
            {{ end }}
            <td>{{ time .Track.CreatedAt }}</td>
            <td>{{ time .LastLogin }}</td>
            <td>{{ .LastIP }}</td>
            <td>
              <button data-operation="edit" data-userID="{{ .ID }}" data-edituser="{{ .Username }}"
                data-editrole="{{ .Role }}" type="button" class="btn btn-outline-primary mr-1" data-toggle="modal"
                data-target="#modal-edit">Edit</button>
              <button data-operation="kick" data-userID="{{ .ID }}" type="button"
                class="btn btn-outline-warning mr-1">Kick</button>
              <button data-operation="delete" data-userID="{{ .ID }}" type="button" class="btn btn-outline-danger"
                data-toggle="modal" data-target="#modal-delete">Delete</button>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-add" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Add User</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <form id="addUser" action="/api/user" method="post" class="form-horizontal">
        <div class="modal-body">
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Username</label>
            <div class="col-sm-10">
              <input name="username" type="text" class="form-control" placeholder="Username" maxlength="32" required>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Password</label>
            <div class="col-sm-10">
              <input name="password" type="password" class="form-control" placeholder="Password" required>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Role</label>
            <div class="col-sm-10">
              <select name="role" class="form-control">
                <option>User</option>
                <option>Admin</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-edit" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Edit User</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <form id="editUser" method="patch" class="form-horizontal">
        <div class="modal-body">
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Username</label>
            <div class="col-sm-10">
              <input id="editUsername" name="username" type="text" class="form-control" placeholder="Username"
                maxlength="32" required>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Password</label>
            <div class="col-sm-10">
              <input id="editPassword" name="password" type="password" class="form-control" placeholder="NOT CHANGE">
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Role</label>
            <div class="col-sm-10">
              <select id="editRole" name="role" class="form-control">
                <option>User</option>
                <option>Admin</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-delete" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-danger">
      <div class="modal-header">
        <h4 class="modal-title">Delete User</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Once delete, all data associated to this user will be deleted PERMANENTLY!</p>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-outline-light" data-dismiss="modal">Cancel</button>
        <button id="deleteConfirm" type="button" class="btn btn-outline-light">Confirm</button>
      </div>
    </div>
  </div>
</div>
{{end}}

{{define "js"}}
<script nonce="{{ ._nonce }}">
  "use strict"

  const convUser = (d) => {
    switch (d["role"]) {
      case "User":
        d["role"] = 1;
        break;
      case "Admin":
        d["role"] = 2;
        break;
    }
    return d;
  }

  $("[data-toggle='switch']").bootstrapSwitch();
  $("[data-operation='edit']").click((e) => {
    $("#editUser").attr("action", `/api/user/${e.target.getAttribute("data-userID")}`)
    $("#editUsername").val(e.target.getAttribute("data-edituser"));
    $("#editRole").get(0).selectedIndex = e.target.getAttribute("data-editrole") - 1;
  })
  $("#editUser").submit((e) => {
    e.preventDefault();
    let form = document.getElementById("editUser");
    JSONPatch(GetUrl(form), convUser(GetData(form))).done((d) => {
      $('#modal-edit').modal('hide');
      DelayReload()(d);
    });
  })
  $("[data-operation='kick']").click((e) => {
    JSONPatch(`/api/user/${e.target.getAttribute("data-userID")}`, {}).done(DelayReload());
  })
  $("[data-operation='delete']").click((e) => {
    $("#deleteConfirm").attr("data-userID", e.target.getAttribute("data-userID"));
  })
  $("#deleteConfirm").click((e) => {
    JSONDelete(`/api/user/${e.target.getAttribute("data-userID")}`).done((d) => {
      $('#modal-delete').modal('hide');
      DelayReload()(d);
    });
  })
  $("#addUser").submit((e) => {
    e.preventDefault();
    let form = document.getElementById("addUser");
    JSONPost(GetUrl(form), convUser(GetData(form))).done((d) => {
      $('#modal-add').modal('hide');
      DelayReload()(d);
    });
  });
</script>
{{end}}